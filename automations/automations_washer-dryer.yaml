###############################################################
###  Washer Dryer - test state, detect if finished          ### 
###############################################################
  - alias: Action - Set washing machine to running
    trigger:
    - platform: numeric_state
      entity_id: sensor.washer_dryer_energy_monitor_watts
      above: '6'
      for:
        minutes: 10
    condition: []
    action:
    - service: input_select.select_option
      data:
        entity_id: input_select.washingmachine_status
        option: "Running"

  - alias: Action - Set washing machine as finished
    trigger:
    - platform: numeric_state
      entity_id: sensor.washer_dryer_energy_monitor_watts
      below: '10'
      for:
        minutes: 7
    condition:
    - condition: state
      entity_id: input_select.washingmachine_status
      state: "Running"
    action:
    - service: input_select.select_option
      data:
        entity_id: input_select.washingmachine_status
        option: "Finished"

# Finished, notify someone, set status to off
  - alias: Notify - Washing machine finished
    trigger:
    - platform: state
      entity_id: input_select.washingmachine_status
      to: "Finished"
    action:
    - service: homeassistant.turn_on
      data:
        entity_id: input_boolean.washingmachine_needs_emptying
    - service: homeassistant.turn_on
      entity_id: script.washer_dryer_needs_emptying_loop
    - service: input_select.select_option
      data:
        entity_id: input_select.washingmachine_status
        option: "Powered Off"
        

###############################################################
####         Washer dryer report status              ###
###############################################################
  - alias: Emptied the washing machine
    trigger:
    - platform: state
      entity_id: input_boolean.washingmachine_status_enquiry
      to: "on"
    action:
    - service: homeassistant.turn_off
      data:
        entity_id: input_boolean.washingmachine_needs_emptying
    - service: script.house_announce_diningroom
      data_template:
        tts_msg: "Washing machine status update acknowledged."
###############################################################
####         Washer dryer actionable notifications          ###
###############################################################
# moved this to the script
#  - alias: Washer dryer actionable notification
#    initial_state: True
#    trigger:
#      platform: state
#      # when my bedroom fan turns on
#      entity_id:  input_boolean.washingmachine_needs_emptying
#      from: 'off'
#      to: 'on'
#    action:
#      service: notify.mobile_app_timh_iphonex
#      data:
#        title: "Laundry alert!"
#        message: "The washer dryer needs emptying."
#        data:
#          push:
#            badge: 1
#            # sound: <SOUND FILE HERE>
#            category: "washerdryeremptying" # Needs to match the top level identifier you used in the ios configuration  - Don't forget to 'Update push settings' on the iOS app!
#
# Triggered by responses
  - alias: Washer dryer notification response 1
    trigger:
      platform: event
      event_type: ios.notification_action_fired
      event_data:
        actionName: WASHER_DRYER_EMPTYING_1
    action:
      - service: script.house_announce_diningroom
        data_template:
          tts_msg: "Okay, I'll remind you in ten minutes."
  # Flip the input_boolean, end the message loop
  - alias: Washer dryer notification response 2
    trigger:
      platform: event
      event_type: ios.notification_action_fired
      event_data:
        actionName: WASHER_DRYER_EMPTYING_2
    action:
      - service: homeassistant.turn_off
        data:
          entity_id: input_boolean.washingmachine_needs_emptying
      - service: script.house_announce_diningroom
        data_template:
          tts_msg: "Okay, I'll stop reminding you."
        